DECLARE @ArtikelNr nchar(15) = N'890001';
DECLARE @VKPreis money = 0.58;
DECLARE @UserID int = (SELECT ID FROM Mitarbei WHERE MitarbeiUser = N'THALST');

DECLARE @Kunde TABLE (
  KdNr int
);

DECLARE @PreisChanged TABLE (
  KdArtiID int,
  LeasPreis money,
  WaschPreis money,
  SonderPreis money,
  VKPreis money,
  BasisRestwert money,
  LeasPreisAbwAbWo money,
  LeasPreisPrListKdArtiID int,
  WaschPreisPrListKdArtiID int,
  SondPreisPrListKdArtiID int,
  VkPreisPrListKdArtiID int,
  BasisRWPrListKdArtiID int,
  VkPreisOld money
);

INSERT INTO @Kunde (KdNr)
VALUES (217830), (10006256), (10006434), (10006435), (10005962), (271768), (203961), (233145), (233145), (271768), (200421), (248408), (219908), (218331), (219908), (10006027), (10005964), (10005939), (10005930), (10005736), (10005736), (10005604), (240810), (10005984), (10005924), (10005931), (10005934), (10005736), (10005938), (10005858), (10005860), (10003399), (10005904), (240119), (240894), (10005604), (10005736), (241222), (10005597), (218134), (10005647), (10005648), (10005667), (246020), (10005257), (279228), (10002195), (272813), (10004789), (272813), (30186), (10004928), (245430), (272847), (246182), (242623), (249112), (246025), (10003072), (272525), (10002194), (249386), (271425), (272806), (272813), (10003725), (240879), (245039), (10000993), (246172), (246360), (244657), (245877), (246075), (247685), (10002164), (246572), (10002741), (248337), (2529603), (40073), (10006130), (10006122), (10005933), (10005226), (10006266), (10006268), (10006311), (10006313), (10006016), (10005996), (10005737), (246323), (249361), (249109), (10006449), (10006372), (10006374), (10006411), (10006418), (10006419), (10006420), (100700), (10006433), (10006461), (10006125), (10006477), (10005819), (10006510), (10005079), (10005078), (10006518), (246255), (10006259), (246315), (10006530), (10006544), (2521444), (10006199), (10006216), (10006221), (10006575), (10006654), (100120), (218331), (233030), (10005371), (10006706), (240345), (240792), (10006672), (240350), (217985), (10006561), (10003254), (245787), (246754), (10006005), (10005953), (10006327), (190107), (10006169), (270797), (10002797), (240323), (10003071), (246047), (249189), (245330), (245190), (249126), (245325), (10004057), (10002726), (10002944), (272641), (248358), (270389), (10000992), (10000860), (10000859), (250164), (245428), (248338), (240792), (246032), (201010), (249297), (249587), (240398), (240756), (240350), (272816), (272283), (10002650), (271511), (249058), (249746), (247577), (240705), (240079), (246297), (240165), (240190), (240345), (271378), (246754), (249965), (245393), (247867), (246019), (246051), (246094), (246181), (245148), (249397), (247678), (240397), (240884), (240431), (240550), (293707), (272050), (246748), (271378), (248593), (248728), (240305), (240309), (246039), (10002508), (10003734), (240375), (10001303), (10001576), (271362), (249962), (248384), (245153), (247488), (245944), (272677), (240909), (240432), (246207), (248312), (240302), (240318), (240339), (272295), (10002798), (10001552), (246043), (246076), (249745), (249247), (240167), (240168), (272834), (272833), (272283), (202594), (10000624), (233066), (233231), (270853), (233305), (232495), (10001596), (10001582), (299771), (272535), (292462), (291912), (292824), (293610), (293631), (289624), (233186), (245549), (218840), (293041), (202230), (216896), (293150), (280095), (293358), (293701), (293756), (294078), (293578), (293966), (215361), (201624), (292540), (299422), (299846), (292524), (293377), (291593), (291654), (290387), (293493), (292330), (292839), (299037), (299090), (299250), (291926), (294150), (292991), (293893), (270297), (299162), (299163), (10002405), (10002086), (10004503), (299600), (299109), (292689), (292912), (299868), (10002959), (10002960), (293073), (2522835), (2529569), (299672), (218064), (215476), (293611), (292888), (202233), (218645), (219733), (293539), (202706), (299145), (200768), (202191), (10002046), (10002344), (10002028), (10001876), (10001690), (10002958), (10003168), (10004803), (10004525), (10004786), (10004313), (10004834), (10003915), (180065), (248312), (271569), (292888), (200460), (200476), (201655), (201975), (204551), (219874), (215617), (215731), (218111), (215353), (10000500), (230926), (233369), (10002272), (10003125), (10004847), (10004427), (10004859), (10004339), (215732), (215881), (215947), (216415), (216421), (216426), (216506), (216620), (216772), (216779), (216785), (218306), (218331), (218374), (218395), (218396), (218427), (218451), (200206), (201220), (205910), (215596), (215655), (215664), (216849), (216915), (218777), (218790), (218876), (218877), (217512), (217547), (217806), (217985), (218141), (218749), (215099), (215215), (215467), (207171), (209365), (207561), (207636), (10000768), (10000425), (10000426), (10000065), (234235), (10000536), (270520), (10000611), (215976), (231281), (233030), (10000239), (10000239), (231534), (270816), (233170), (10000037), (10000062), (233357), (270906), (270934), (10000282), (232387), (233371), (10001147), (10001614), (10001423), (10001183), (10002161), (10001988), (10002039), (10002392), (10002755), (10002887), (10002888), (10002816), (10002955), (10002759), (10003079), (10003252), (10003043), (10003089), (10003310), (10003329), (10003050), (10003040), (10003170), (10003272), (10003206), (10003378), (10004006), (10004796), (10004797), (10005392), (10004257), (10005418), (10005369), (10005370), (10004946), (10003527), (10003577), (10005270), (10005409), (10004019), (271768), (200575), (251214), (251215), (246969), (245112), (246058), (246367), (249346), (245301), (247205), (250433), (245929), (249296), (245991), (250476), (240069), (241759), (246664), (246665), (242467), (250309), (250753), (250750), (240704), (249111), (240275), (246209), (250782), (10003941), (10004508), (200544), (200027), (200119), (200132), (200162), (200207), (205598), (200268), (200277), (200290), (200343), (202789), (215134), (202924), (201631), (215629), (201135), (201280), (201710), (201753), (202104), (202262), (202290), (202403), (202415), (204600), (203473), (203669), (219256), (219305), (10005823), (10002304), (10002305), (10005818), (240622), (272441), (233002), (10004700), (200812), (200898), (200381), (200438), (217117), (200471), (219927), (219053), (219134), (219139), (219140), (219182), (219498), (219556), (219853), (271657), (216904), (272045), (272066), (272067), (217432), (217440), (215527), (215563), (215609), (215710), (202152), (10005917), (10005909), (10005900), (10005940), (10005942), (10001878);

/* SELECT Kunden.KdNr, Artikel.ArtikelNr, Artikel.ArtikelBez, KdArti.Variante, KdArti.LeasPreis, KdArti.WaschPreis, KdArti.SonderPreis, KdArti.VkPreis */
UPDATE KdArti SET VkPreis = @VKPreis
OUTPUT inserted.ID, inserted.LeasPreis, inserted.WaschPreis, inserted.SonderPreis, inserted.VkPreis, inserted.BasisRestwert, inserted.LeasPreisAbwAbWo, inserted.LeasPreisPrListKdArtiID, inserted.WaschPreisPrListKdArtiID, inserted.SondPreisPrListKdArtiID, inserted.VkPreisPrListKdArtiID, inserted.BasisRWPrListKdArtiID, deleted.VkPreis
INTO @PreisChanged (KdArtiID, LeasPreis, WaschPreis, SonderPreis, VKPreis, BasisRestwert, LeasPreisAbwAbWo, LeasPreisPrListKdArtiID, WaschPreisPrListKdArtiID, SondPreisPrListKdArtiID, VkPreisPrListKdArtiID, BasisRWPrListKdArtiID, VkPreisOld)
FROM KdArti
JOIN Kunden ON KdArti.KundenID = Kunden.ID
JOIN Artikel ON KdArti.ArtikelID = Artikel.ID
WHERE Kunden.KdNr IN (SELECT KdNr FROM @Kunde)
  AND Artikel.ArtikelNr = @ArtikelNr
  AND KdArti.VkPreis != @VKPreis;

INSERT INTO PrArchiv (KdArtiID, Datum, LeasPreis, WaschPreis, SonderPreis, VKPreis, BasisRestwert, LeasPreisAbwAbWo, MitarbeiID, Aktivierungszeitpunkt, LeasPreisPrListKdArtiID, WaschPreisPrListKdArtiID, SondPreisPrListKdArtiID, VkPreisPrListKdArtiID, BasisRWPrListKdArtiID, AnlageUserID_, UserID_)
SELECT KdArtiID, CAST(GETDATE() AS date) AS Datum, LeasPreis, WaschPreis, SonderPreis, VKPreis, BasisRestwert, LeasPreisAbwAbWo, @UserID AS MitarbeiID, GETDATE() AS Aktivierungszeitpunkt, LeasPreisPrListKdArtiID, WaschPreisPrListKdArtiID, SondPreisPrListKdArtiID, VkPreisPrListKdArtiID, BasisRWPrListKdArtiID, @UserID AS AnlageUserID_, @UserID AS UserID_
FROM @PreisChanged;

SELECT Kunden.KdNr, Kunden.SuchCode AS Kunde, Artikel.ArtikelNr, Artikel.ArtikelBez, KdArti.Variante, [@PreisChanged].VkPreisOld AS [VK-Preis bisher], KdArti.VkPreis AS [VK-Preis neu]
FROM @PreisChanged
JOIN KdArti ON [@PreisChanged].KdArtiID = KdArti.ID
JOIN Artikel ON KdArti.ArtikelID = Artikel.ID
JOIN KUnden ON KdArti.KundenID = Kunden.ID;