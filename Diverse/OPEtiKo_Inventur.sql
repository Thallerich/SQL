-- Inventiert:

SELECT Kunden.KdNr, Kunden.SuchCode AS Kunde, Vsa.SuchCode AS [Vsa-Stichwort], Vsa.Bez AS [Vsa-Bezeichnung], Artikel.ArtikelNr, Artikel.ArtikelBez$LAN$ AS Artikelbezeichnung, OPEtiKo.EtiNr AS Seriennummer, Status.StatusBez AS Status
FROM OPEtiKo, Vsa, Kunden, Artikel, (SELECT Status.Status, Status.StatusBez$LAN$ AS StatusBez FROM Status WHERE Status.Tabelle = 'OPETIKO') AS Status
WHERE OPEtiKo.VsaID = Vsa.ID
  AND Vsa.KundenID = Kunden.ID
  AND OPEtiKo.ArtikelID = Artikel.ID
  AND OPEtiKo.Status = Status.Status
  AND OPEtiKo.EtiNr IN ('1156723645', '1156723744', '1156723669', '1156479719', '1156841141', '1156723737', '1156723652', '1156668502', '1156668465', '1156668397', '1156723713', '1156668533', '1156479887', '1156494378', '1155658511', '1156479924', '1156560660', '1156097708', '1156416899', '1157458966', '1157458942', '1156416936', '1157377137', '1157458980', '1157458973', '1157458928', '1156494170', '1156494446', '1157523534', '1156494491', '1156560516', '1156944576', '1156944552', '1157523473', '1156723676', '1156494484', '1157041687', '1157523459', '1156560523', '1156723591', '1156723607', '1157041670', '1157041618', '1156944569', '1156560547', '1156944583', '1157041700', '1157041663', '1157041625', '1156494187', '1156793372', '1157042035', '1155658504', '1157041946', '1157042066', '1156494361', '1156793327', '1156416943', '1156494286', '1157458904', '1157377182', '1156494163', '1155486893', '1156097739', '1156943371', '1156560639', '1157671259', '1157671105', '1157584597', '1157458843', '1157219741', '1156723492', '1157524999', '1157299354', '1157395377', '1156559992', '1155935544', '1155935513', '1155935575', '1148916352', '1148916390', '1156404476', '1148916369', '1148916383', '1156417216', '1157041052', '1156417261', '1156816477', '1149335428', '1151889216', '1156417209', '1156816354', '1153044484', '1152466089', '1152803709', '1156009565', '1149335275', '1157584696', '1157043216', '1157522797', '1157668488', '1157669416', '1157584092', '1157584382', '1157669447', '1157584085', '1157668457', '1157522841', '1156667420', '1157670436', '1157668501', '1157668518', '1157670443', '1157668549', '1157670474', '1157523138', '1157119188', '1157043230', '1149023202', '1149023189', '1149023165', '1149023172', '1155493259', '1155493266', '1157119645', '1156942664', '1157670757', '1149809653', '1149209033', '1149209002', '1149209026', '1149209040', '1151705301', '1148228691', '1151546461', '1148228752', '1151888660', '1152369014', '1155743620', '1155854807', '1157300005', '1156723447', '1152290240', '1153841571', '1154618370', '1154618394', '1154732502', '1155674962', '1154618400', '1157525040', '1157525019', '1157041236', '1157458799', '1157458850', '1157671112', '1156247301', '1157584757', '1155854371', '1156100712', '1156560080', '1156723386', '1156816385', '1157218409', '1157218584', '1157236564', '1157668433', '1157119546', '1157218614', '1157395643', '1157584825', '1156100866', '1155854616', '1156100897', '1157671235', '1157395582', '1156247745', '1156247653', '1156247738', '1157244323', '1157525064', '1154096178', '1152467222', '1153995991', '1156247035', '1156942701', '1155950226', '1156723102', '1156247066', '1156010608', '1156100552', '1157670917', '1156315192', '1157298951', '1157244248', '1157244156', '1157584627', '1154155943', '1153632292', '1154155936', '1157118952', '1157118969', '1157668020', '1157668006', '1157668013', '1157218898', '1157391928', '1157668594', '1156558407', '1156558315', '1156558384', '1156558353', '1156558322', '1156722495', '1156810383', '1157042714', '1157042707', '1157042677', '1157042684', '1157118945', '1157522537', '1157522544', '1149208715', '1149208722', '1149208920', '1149208791', '1149208746', '1150592322', '1150240841', '1150390126', '1150390225', '1151167000', '1151167017', '1151167482', '1152541588', '1152697063', '1152806519', '1152806502', '1152860795', '1152961317', '1152961300', '1155300427', '1155300434', '1155300441', '1155583264', '1155214519', '1156404483', '1156722525', '1157391911', '1157583989', '1154788486', '1149208098', '1149208111', '1149208135', '1149208197', '1149208180', '1149208173', '1149591848', '1149591831', '1149757329', '1149793235', '1153534572', '1157297305', '1149208234', '1149208227', '1149208531', '1149208548', '1149208487', '1149208562', '1149208609', '1149208401', '1149208388', '1149208432', '1149208463', '1149208449', '1149208470', '1149208654', '1149208425', '1149208494', '1149208500', '1149208524', '1149208630', '1149208517', '1149208623', '1149208210', '1149208456', '1149208258', '1149208685', '114920', '1149208692', '1149208340', '1149208289', '11492083', '1149208371', '1149208326', '114920', '1149208661', '1149208586', '1149208593', '1149208579', '1149208265', '1149208302', '1149208241', '1149208203', '1149208272', '1149208357', '1149208418', '1149208364', '1149208395', '1149208296', '1149208333', '1149208555', '1149208616', '1150772694', '1150772656', '1150772724', '1153461014', '1153119182', '1153119175', '1154411254', '1156663071', '1156663057', '1156105113', '1156105083', '1156105106', '1156105090', '1156105076', '1155845140', '1154614808', '1153307985', '1156942800', '1157118792', '1157118815', '1157118839', '1157522339', '1157522353', '1157522346', '1157583941', '1157583958', '1157667962', '1157667993', '1157667979', '1157667986', '1157667955', '1157667948', '1157667931', '1157522469', '1157522490', '1157522377', '1157522414', '1157391850', '1157391843', '1157522483', '1157522391', '1157522506', '1157522520', '1157668280', '1149207800', '1149207862', '1149207893', '1149409075', '1149409143', '1149409099', '1151266277', '1149207855', '1140207879', '1149207848', '1149207787', '1149207763', '1149207770', '1149207756', '1149207626', '1149207794', '1149207640', '1149207732', '1149207688', '1149207695', '1149207749', '1149207671', '1149207633', '1149207725', '1149207701', '1149207718', '1149207657', '1149207619', '1150940383', '1157458119', '1157458126', '1157458164', '1157458157', '1157458089', '1157458171', '1157458133', '1157458140', '1157669300', '1157668372', '1157668396', '1157668389', '1157668365', '1157668310', '1157668327', '1157668358', '1157668341', '1157669294', '1157297190', '1157668242', '1157668150', '1157668181', '1157668297', '1157668273', '1157668259', '1157668266', '1157668211', '1157668228', '1157668204', '1157668235', '1157668198', '1157668174', '1157668167', '1157669263', '1157669348', '1157669331', '1157669270', '1157668402', '1157668426', '1157669317', '1157668419', '1157668334', '1157669287', '1157668303', '1155039785', '1157119980', '1156417094', '1157042219', '1156668212', '1157042370', '1157042394', '1157042301', '1157119966', '1157119997', '1157042325', '1156816767', '1154159576', '1154712320', '1154595060', '1156403899', '1155487074', '1151455084', '1153462080', '1152287851', '1152372502', '1152287714', '1157523015', '1157668037', '1155583257', '1156663323', '1150391246', '1157668051', '1150154629', '1157458072', '1156558346', '1156558339', '1156476398', '1152044041', '1156663064', '1157583965', '1157042547', '1153533575', '1156246519', '1150513990', '1156105274', '1156105243', '1157042462', '1156942831', '1157098421', '1157098421', '1148825357', '1154157664', '1150593183', '1150593190', '1156105328', '1157297299', '1157042981', '1157042820', '1157042837', '1157042806', '1157042790', '1157042950', '1157042813', '1152349122', '1156722570', '1156944064', '1156942732', '1157119850', '1157458768', '1157119829', '1157523145', '1157524869', '1157522926', '1157524890', '1156943777', '1151886703', '1149209057', '1149207558', '1149209163', '1150596337', '1155039297', '1154710951', '1148233657', '1153308203', '1153308302', '1157458195', '1155039259', '1149208982');
  
-- Nicht Inventiert:  
  
TRY
  DROP TABLE #OPEtiKo;
  DROP TABLE #OPEtiKoSiS;
  DROP TABLE #NichtInventiert;
  DROP TABLE #OPTeile;
  DROP TABLE #OPTeileSiS;
CATCH ALL END;

SELECT OPEtiKo.*
INTO #OPEtiKo
FROM OPEtiKo, Vsa, Kunden
WHERE OPEtiKo.VsaID = Vsa.ID
  AND Vsa.KundenID = Kunden.ID
  AND Kunden.KdNr = 23031
  AND OPEtiKo.Status = 'R';
  
SELECT OPEtiKo.ID AS OPEtiKoID, Kunden.KdNr, Kunden.SuchCode AS Kunde, Vsa.SuchCode AS [Vsa-Stichwort], Vsa.Bez AS [Vsa-Bezeichnung], Artikel.ArtikelNr, Artikel.ArtikelBez$LAN$ AS Artikelbezeichnung, OPEtiKo.EtiNr AS Seriennummer, Status.StatusBez AS Status
INTO #NichtInventiert
FROM #OPEtiKo AS OPEtiKo, Vsa, Kunden, Artikel, (SELECT Status.Status, Status.StatusBez$LAN$ AS StatusBez FROM Status WHERE Status.Tabelle = 'OPETIKO') AS Status
WHERE OPEtiKo.VsaID = Vsa.ID
  AND Vsa.KundenID = Kunden.ID
  AND OPEtiKo.ArtikelID = Artikel.ID
  AND OPEtiKo.Status = Status.Status
  AND NOT EXISTS (
    SELECT OPSets.*
    FROM OPSets
    WHERE OPSets.Artikel1ID = OPEtiKo.ArtikelID)
  AND OPEtiKo.AusleseZeitpunkt < '27.05.2015 00:00:00'
  AND OPEtiKo.EtiNr NOT IN ('1156723645', '1156723744', '1156723669', '1156479719', '1156841141', '1156723737', '1156723652', '1156668502', '1156668465', '1156668397', '1156723713', '1156668533', '1156479887', '1156494378', '1155658511', '1156479924', '1156560660', '1156097708', '1156416899', '1157458966', '1157458942', '1156416936', '1157377137', '1157458980', '1157458973', '1157458928', '1156494170', '1156494446', '1157523534', '1156494491', '1156560516', '1156944576', '1156944552', '1157523473', '1156723676', '1156494484', '1157041687', '1157523459', '1156560523', '1156723591', '1156723607', '1157041670', '1157041618', '1156944569', '1156560547', '1156944583', '1157041700', '1157041663', '1157041625', '1156494187', '1156793372', '1157042035', '1155658504', '1157041946', '1157042066', '1156494361', '1156793327', '1156416943', '1156494286', '1157458904', '1157377182', '1156494163', '1155486893', '1156097739', '1156943371', '1156560639', '1157671259', '1157671105', '1157584597', '1157458843', '1157219741', '1156723492', '1157524999', '1157299354', '1157395377', '1156559992', '1155935544', '1155935513', '1155935575', '1148916352', '1148916390', '1156404476', '1148916369', '1148916383', '1156417216', '1157041052', '1156417261', '1156816477', '1149335428', '1151889216', '1156417209', '1156816354', '1153044484', '1152466089', '1152803709', '1156009565', '1149335275', '1157584696', '1157043216', '1157522797', '1157668488', '1157669416', '1157584092', '1157584382', '1157669447', '1157584085', '1157668457', '1157522841', '1156667420', '1157670436', '1157668501', '1157668518', '1157670443', '1157668549', '1157670474', '1157523138', '1157119188', '1157043230', '1149023202', '1149023189', '1149023165', '1149023172', '1155493259', '1155493266', '1157119645', '1156942664', '1157670757', '1149809653', '1149209033', '1149209002', '1149209026', '1149209040', '1151705301', '1148228691', '1151546461', '1148228752', '1151888660', '1152369014', '1155743620', '1155854807', '1157300005', '1156723447', '1152290240', '1153841571', '1154618370', '1154618394', '1154732502', '1155674962', '1154618400', '1157525040', '1157525019', '1157041236', '1157458799', '1157458850', '1157671112', '1156247301', '1157584757', '1155854371', '1156100712', '1156560080', '1156723386', '1156816385', '1157218409', '1157218584', '1157236564', '1157668433', '1157119546', '1157218614', '1157395643', '1157584825', '1156100866', '1155854616', '1156100897', '1157671235', '1157395582', '1156247745', '1156247653', '1156247738', '1157244323', '1157525064', '1154096178', '1152467222', '1153995991', '1156247035', '1156942701', '1155950226', '1156723102', '1156247066', '1156010608', '1156100552', '1157670917', '1156315192', '1157298951', '1157244248', '1157244156', '1157584627', '1154155943', '1153632292', '1154155936', '1157118952', '1157118969', '1157668020', '1157668006', '1157668013', '1157218898', '1157391928', '1157668594', '1156558407', '1156558315', '1156558384', '1156558353', '1156558322', '1156722495', '1156810383', '1157042714', '1157042707', '1157042677', '1157042684', '1157118945', '1157522537', '1157522544', '1149208715', '1149208722', '1149208920', '1149208791', '1149208746', '1150592322', '1150240841', '1150390126', '1150390225', '1151167000', '1151167017', '1151167482', '1152541588', '1152697063', '1152806519', '1152806502', '1152860795', '1152961317', '1152961300', '1155300427', '1155300434', '1155300441', '1155583264', '1155214519', '1156404483', '1156722525', '1157391911', '1157583989', '1154788486', '1149208098', '1149208111', '1149208135', '1149208197', '1149208180', '1149208173', '1149591848', '1149591831', '1149757329', '1149793235', '1153534572', '1157297305', '1149208234', '1149208227', '1149208531', '1149208548', '1149208487', '1149208562', '1149208609', '1149208401', '1149208388', '1149208432', '1149208463', '1149208449', '1149208470', '1149208654', '1149208425', '1149208494', '1149208500', '1149208524', '1149208630', '1149208517', '1149208623', '1149208210', '1149208456', '1149208258', '1149208685', '114920', '1149208692', '1149208340', '1149208289', '11492083', '1149208371', '1149208326', '114920', '1149208661', '1149208586', '1149208593', '1149208579', '1149208265', '1149208302', '1149208241', '1149208203', '1149208272', '1149208357', '1149208418', '1149208364', '1149208395', '1149208296', '1149208333', '1149208555', '1149208616', '1150772694', '1150772656', '1150772724', '1153461014', '1153119182', '1153119175', '1154411254', '1156663071', '1156663057', '1156105113', '1156105083', '1156105106', '1156105090', '1156105076', '1155845140', '1154614808', '1153307985', '1156942800', '1157118792', '1157118815', '1157118839', '1157522339', '1157522353', '1157522346', '1157583941', '1157583958', '1157667962', '1157667993', '1157667979', '1157667986', '1157667955', '1157667948', '1157667931', '1157522469', '1157522490', '1157522377', '1157522414', '1157391850', '1157391843', '1157522483', '1157522391', '1157522506', '1157522520', '1157668280', '1149207800', '1149207862', '1149207893', '1149409075', '1149409143', '1149409099', '1151266277', '1149207855', '1140207879', '1149207848', '1149207787', '1149207763', '1149207770', '1149207756', '1149207626', '1149207794', '1149207640', '1149207732', '1149207688', '1149207695', '1149207749', '1149207671', '1149207633', '1149207725', '1149207701', '1149207718', '1149207657', '1149207619', '1150940383', '1157458119', '1157458126', '1157458164', '1157458157', '1157458089', '1157458171', '1157458133', '1157458140', '1157669300', '1157668372', '1157668396', '1157668389', '1157668365', '1157668310', '1157668327', '1157668358', '1157668341', '1157669294', '1157297190', '1157668242', '1157668150', '1157668181', '1157668297', '1157668273', '1157668259', '1157668266', '1157668211', '1157668228', '1157668204', '1157668235', '1157668198', '1157668174', '1157668167', '1157669263', '1157669348', '1157669331', '1157669270', '1157668402', '1157668426', '1157669317', '1157668419', '1157668334', '1157669287', '1157668303', '1155039785', '1157119980', '1156417094', '1157042219', '1156668212', '1157042370', '1157042394', '1157042301', '1157119966', '1157119997', '1157042325', '1156816767', '1154159576', '1154712320', '1154595060', '1156403899', '1155487074', '1151455084', '1153462080', '1152287851', '1152372502', '1152287714', '1157523015', '1157668037', '1155583257', '1156663323', '1150391246', '1157668051', '1150154629', '1157458072', '1156558346', '1156558339', '1156476398', '1152044041', '1156663064', '1157583965', '1157042547', '1153533575', '1156246519', '1150513990', '1156105274', '1156105243', '1157042462', '1156942831', '1157098421', '1157098421', '1148825357', '1154157664', '1150593183', '1150593190', '1156105328', '1157297299', '1157042981', '1157042820', '1157042837', '1157042806', '1157042790', '1157042950', '1157042813', '1152349122', '1156722570', '1156944064', '1156942732', '1157119850', '1157458768', '1157119829', '1157523145', '1157524869', '1157522926', '1157524890', '1156943777', '1151886703', '1149209057', '1149207558', '1149209163', '1150596337', '1155039297', '1154710951', '1148233657', '1153308203', '1153308302', '1157458195', '1155039259', '1149208982');
  
SELECT KdNr, Kunde, [Vsa-Stichwort], [Vsa-Bezeichnung], ArtikelNr, Artikelbezeichnung, Seriennummer, Status
FROM #NichtInventiert;

-- Änderung Status nicht inventiert:

SELECT OPTeile.*
INTO #OPTeile
FROM OPEtiPo, OPEtiKo, OPTeile
WHERE OPEtiPo.OPEtiKoID = OPEtiKo.ID
  AND OPEtiPo.OPTeileID = OPTeile.ID
  AND OPEtiPo.OPTeileID > 0
  AND OPEtiKo.ID IN (SELECT OPEtiKoID FROM #NichtInventiert);
  
SELECT OPEtiKo.*
INTO #OPEtiKoSiS
FROM OPEtiKo, #OPTeile AS OPTeile
WHERE OPTeile.Code = OPEtiKo.EtiNr
  AND OPEtiKo.Status = 'R';

SELECT OPTeile.*
INTO #OPTeileSiS
FROM OPEtiPo, #OPEtiKoSiS AS OPEtiKo, OPTeile
WHERE OPEtiPo.OPEtiKoID = OPEtiKo.ID
  AND OPEtiPo.OPTeileID = OPTeile.ID
  AND OPEtiPo.OPTeileID > 0;

UPDATE OPTeile SET Status = 'W' WHERE ID IN (SELECT ID FROM #OPTeileSiS);
UPDATE OPTeile SET Status = 'W' WHERE ID IN (SELECT ID FROM #OPTeile);
  
UPDATE OPEtiKo SET Status = 'Y' WHERE ID IN (SELECT ID FROM #OPEtiKoSiS);
UPDATE OPEtiKo SET Status = 'Y' WHERE ID IN (SELECT OPEtiKoID FROM #NichtInventiert);

-- Korrektur Ist-Bestände:

TRY
  DROP TABLE #VsaAnf;
CATCH ALL END;

SELECT Artikel.ID AS ArtikelID, Artikel.ArtikelNr, Artikel.ArtikelBez$LAN$, VsaAnf.ID AS VsaAnfID, VsaAnf.VsaID, VsaAnf.Bestand, VsaAnf.BestandIst, 0 AS AnzahlSets
INTO #VsaAnf
FROM VsaAnf, Vsa, Kunden, KdArti, Artikel
WHERE VsaAnf.VsaID = Vsa.ID
  AND VsaAnf.KdArtiID = KdArti.ID
  AND KdArti.ArtikelID = Artikel.ID
  AND Vsa.KundenID = Kunden.ID
  AND Kunden.KdNr = 23031
GROUP BY Artikel.ID, Artikel.ArtikelNr, Artikel.ArtikelBez$LAN$, VsaAnfID, VsaAnf.VsaID, VsaAnf.Bestand, VsaAnf.BestandIst;

UPDATE x SET x.AnzahlSets = y.AnzahlSets
FROM #VsaAnf x, (
  SELECT OPEtiKo.ArtikelID, OPEtiKo.VsaID, COUNT(OPEtiKo.EtiNr) AS AnzahlSets
  FROM OPEtiKo, Vsa, Kunden, #VsaAnf VsaAnf
  WHERE OPEtiKo.ArtikelID = VsaAnf.ArtikelID
    AND OPEtiKo.VsaID = Vsa.ID
    AND Vsa.KundenID = Kunden.ID
    AND Kunden.KdNr = 23031
    AND OPEtiKo.Status = 'R'
  GROUP BY OPEtiKo.ArtikelID, OPEtiKo.VsaID
) y
WHERE x.ArtikelID = y.ArtikelID
  AND x.VsaID = y.VsaID;

UPDATE VsaAnf SET VsaAnf.BestandIst = x.AnzahlSets
FROM VsaAnf, #VsaAnf x
WHERE VsaAnf.ID = x.VsaAnfID;

SELECT Kunden.KdNr, Kunden.SuchCode AS Kunde, Vsa.SuchCode AS [Vsa-Stichwort], Vsa.Bez AS [Vsa-Bezeichnung], Artikel.ArtikelNr, Artikel.ArtikelBez$LAN$ AS Artikelbezeichnung, VsaAnf.Bestand AS Vertragsbestand, VsaAnf.BestandIst AS [Ist-Bestand]
FROM VsaAnf, Vsa, Kunden, KdArti, Artikel
WHERE VsaAnf.VsaID = Vsa.ID
  AND Vsa.KundenID = Kunden.ID
  AND VsaAnf.KdArtiID = KdArti.ID
  AND KdArti.ArtikelID = Artikel.ID
  AND Kunden.KdNr = 23031
  AND VsaAnf.Bestand > 0
ORDER BY Kunden.KdNr, [Vsa-Stichwort], Artikel.ArtikelNr;