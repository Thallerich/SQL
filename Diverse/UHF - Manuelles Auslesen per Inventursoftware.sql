USE Wozabal
GO

DECLARE @PZ nchar(8);
DECLARE @Ziel integer;
DECLARE @VsaID integer;

SET @PZ = N'11197459';
SET @Ziel = 264;  --Kabine Budweis
SET @VsaID = (SELECT VsaID FROM AnfKo WHERE AuftragsNr = @PZ);

INSERT INTO OPScans (Zeitpunkt, OPTeileID, ZielNrID, AnfPoID)
SELECT N'2017-05-19 11:00:00' AS Zeitpunkt, x.OPTeileID, @Ziel AS ZielNrID, x.AnfPoID
FROM (
  SELECT OPTeile.ID AS OPTeileID, AnfPo.ID AS AnfPoID
  FROM OPTeile, AnfPo, AnfKo, KdArti
  WHERE AnfPo.AnfKoID = AnfKo.ID
    AND AnfPo.KdArtiID = KdArti.ID
    AND KdArti.ArtikelID = OPTeile.ArtikelID
    AND AnfKo.AuftragsNr = @PZ
    AND OPTeile.Code IN (N'303443ED10271044000022CC', N'303443ED1027104000000935', N'303443828049894400001E61', N'303443E36027104400003B5D', N'30344381E0493E44000001A9', N'303443ED1027104400001CDA', N'303443ED1027104400002359', N'303443DFA027104400005F24', N'303443DFA02710404000622A', N'303443DFA027104040005AE6', N'303443ED1027104040001FC0', N'303443ED10271040000008C0', N'303443ED102710440000236E', N'30344381E0493E404000047E', N'300ED89F33500040000142A3', N'303443ED10271044000019AE', N'30344381E0493E404000040D', N'303443DFA0271044000203B1', N'303443DFA027104040005B8E', N'30344381E0493E44000001DF', N'303443ED1027104040002B08', N'303443E36027104040003A3C', N'303443ED1027104400002170', N'303443828049894400001DCD', N'303443ED1027104400001D15', N'303443E36027104040003D63', N'303443DFA0271044000021BC', N'303443E36027104040004472', N'303443DFA027104040000FEC', N'303443ED10271040400027F8', N'303443E36027104040002F5E', N'303443828049894400001D68', N'303443ED1027104400000841', N'303443ED1027104400000B4C', N'303443E36027104040002E26', N'303443E36027294400000724', N'303443828049894400001E06', N'303443828049894400001E55', N'303443DFA02710440000B16E', N'303443DFA027104000006BEE', N'30344381E0493E40400001D5', N'30344381E0493E4040000274', N'303443E36027104400003D2E', N'303443E36027294400000720', N'303443E36027104400001023', N'303443ED10271040400026A7', N'303443DFA0271044000060FC', N'303443E360271044000025D4', N'303443ED1027104040002515', N'303443E3602729440000070F', N'303443E3602710440000263E', N'303443E3602710404000427C', N'303443ED1027104040002A06', N'303443E36027104400002F49', N'303443DFA027104040006290', N'303443E3602710404000383C', N'303443E360271040400039AC', N'303443DFA02710440001FFC6', N'303443E360271044000030B2', N'303443DFA0271040400065BE', N'30344381E0493E44000002F5', N'303443DFA027104040005E6C', N'303443DFA027104400002261', N'303443E360271044000011FA', N'303443ED1027104040002997', N'303443DFA027104040006849', N'303443828049894400000FF2', N'303443846433774040000246', N'303443846433774040000125', N'3034438464337740400008CF', N'3034438464337740400009F7', N'303443846433774040000BA8', N'30344381E0493E4040000032', N'3034438464337740400009F0', N'303443828049894400001CC4', N'303443828049894400000D50', N'303443DFA02710440000CFC9', N'303443828049894400000CE5', N'303443828049894400000D4B', N'303443828049894400000E67', N'30344381E0493E4040000049', N'303443846433774040000CA6', N'303443828049894400000FF3', N'303443828049894400001CED', N'303443846433774040000C1E', N'303443828049894400001B61', N'303443828049894400001CF7', N'303443ED1027104400000B0E', N'303443828049894400001B04', N'303443828049894400000D78', N'303443846433774040000D65', N'30344381E0493E4040000041', N'303443828049894400000EE8', N'303443828049894400000C41', N'303443828049894400001048', N'303443828049894400001AA4', N'30344382804989440000102D', N'303443828049894400000D48', N'303443828049894400000AEC', N'303443828049894400001364', N'303443828049894400000EDF', N'303443828049894400001144', N'303443828049894400000BFF', N'303443846433774040000674', N'303443DFA027104040006BA1', N'3034438280498944000009F7')
    AND OPTeile.Status BETWEEN 'A' AND 'W'
    AND OPTeile.LastScanTime < N'2017-05-22 00:00:00'
) AS x;

UPDATE AnfPo SET Geliefert = x.Menge, BestaetUser = N'IT', BestaetZeitpunkt = N'2017-05-19 11:00:00'
FROM AnfPo, (
  SELECT AnfPo.ID, COUNT(OPTeile.ID) AS Menge
  FROM OPTeile, AnfPo, AnfKo, KdArti
  WHERE AnfPo.AnfKoID = AnfKo.ID
    AND AnfPo.KdArtiID = KdArti.ID
    AND KdArti.ArtikelID = OPTeile.ArtikelID
    AND AnfKo.AuftragsNr = @PZ
    AND OPTeile.Code IN (N'303443ED10271044000022CC', N'303443ED1027104000000935', N'303443828049894400001E61', N'303443E36027104400003B5D', N'30344381E0493E44000001A9', N'303443ED1027104400001CDA', N'303443ED1027104400002359', N'303443DFA027104400005F24', N'303443DFA02710404000622A', N'303443DFA027104040005AE6', N'303443ED1027104040001FC0', N'303443ED10271040000008C0', N'303443ED102710440000236E', N'30344381E0493E404000047E', N'300ED89F33500040000142A3', N'303443ED10271044000019AE', N'30344381E0493E404000040D', N'303443DFA0271044000203B1', N'303443DFA027104040005B8E', N'30344381E0493E44000001DF', N'303443ED1027104040002B08', N'303443E36027104040003A3C', N'303443ED1027104400002170', N'303443828049894400001DCD', N'303443ED1027104400001D15', N'303443E36027104040003D63', N'303443DFA0271044000021BC', N'303443E36027104040004472', N'303443DFA027104040000FEC', N'303443ED10271040400027F8', N'303443E36027104040002F5E', N'303443828049894400001D68', N'303443ED1027104400000841', N'303443ED1027104400000B4C', N'303443E36027104040002E26', N'303443E36027294400000724', N'303443828049894400001E06', N'303443828049894400001E55', N'303443DFA02710440000B16E', N'303443DFA027104000006BEE', N'30344381E0493E40400001D5', N'30344381E0493E4040000274', N'303443E36027104400003D2E', N'303443E36027294400000720', N'303443E36027104400001023', N'303443ED10271040400026A7', N'303443DFA0271044000060FC', N'303443E360271044000025D4', N'303443ED1027104040002515', N'303443E3602729440000070F', N'303443E3602710440000263E', N'303443E3602710404000427C', N'303443ED1027104040002A06', N'303443E36027104400002F49', N'303443DFA027104040006290', N'303443E3602710404000383C', N'303443E360271040400039AC', N'303443DFA02710440001FFC6', N'303443E360271044000030B2', N'303443DFA0271040400065BE', N'30344381E0493E44000002F5', N'303443DFA027104040005E6C', N'303443DFA027104400002261', N'303443E360271044000011FA', N'303443ED1027104040002997', N'303443DFA027104040006849', N'303443828049894400000FF2', N'303443846433774040000246', N'303443846433774040000125', N'3034438464337740400008CF', N'3034438464337740400009F7', N'303443846433774040000BA8', N'30344381E0493E4040000032', N'3034438464337740400009F0', N'303443828049894400001CC4', N'303443828049894400000D50', N'303443DFA02710440000CFC9', N'303443828049894400000CE5', N'303443828049894400000D4B', N'303443828049894400000E67', N'30344381E0493E4040000049', N'303443846433774040000CA6', N'303443828049894400000FF3', N'303443828049894400001CED', N'303443846433774040000C1E', N'303443828049894400001B61', N'303443828049894400001CF7', N'303443ED1027104400000B0E', N'303443828049894400001B04', N'303443828049894400000D78', N'303443846433774040000D65', N'30344381E0493E4040000041', N'303443828049894400000EE8', N'303443828049894400000C41', N'303443828049894400001048', N'303443828049894400001AA4', N'30344382804989440000102D', N'303443828049894400000D48', N'303443828049894400000AEC', N'303443828049894400001364', N'303443828049894400000EDF', N'303443828049894400001144', N'303443828049894400000BFF', N'303443846433774040000674', N'303443DFA027104040006BA1', N'3034438280498944000009F7')
    AND OPTeile.Status BETWEEN 'A' AND 'W'
    AND OPTeile.LastScanTime < N'2017-05-22 00:00:00'
  GROUP BY AnfPo.ID
) AS x
WHERE x.ID = AnfPo.ID;

UPDATE AnfKo SET Status = N'N' WHERE AuftragsNr = @PZ;

UPDATE OPTeile SET Status = N'R', VsaID = @VsaID, ZielNrID = @Ziel, LastScanTime = N'2017-05-19 11:00:00', LastScanToKunde = N'2017-05-19 11:00:00' 
WHERE OPTeile.Code IN (N'303443ED10271044000022CC', N'303443ED1027104000000935', N'303443828049894400001E61', N'303443E36027104400003B5D', N'30344381E0493E44000001A9', N'303443ED1027104400001CDA', N'303443ED1027104400002359', N'303443DFA027104400005F24', N'303443DFA02710404000622A', N'303443DFA027104040005AE6', N'303443ED1027104040001FC0', N'303443ED10271040000008C0', N'303443ED102710440000236E', N'30344381E0493E404000047E', N'300ED89F33500040000142A3', N'303443ED10271044000019AE', N'30344381E0493E404000040D', N'303443DFA0271044000203B1', N'303443DFA027104040005B8E', N'30344381E0493E44000001DF', N'303443ED1027104040002B08', N'303443E36027104040003A3C', N'303443ED1027104400002170', N'303443828049894400001DCD', N'303443ED1027104400001D15', N'303443E36027104040003D63', N'303443DFA0271044000021BC', N'303443E36027104040004472', N'303443DFA027104040000FEC', N'303443ED10271040400027F8', N'303443E36027104040002F5E', N'303443828049894400001D68', N'303443ED1027104400000841', N'303443ED1027104400000B4C', N'303443E36027104040002E26', N'303443E36027294400000724', N'303443828049894400001E06', N'303443828049894400001E55', N'303443DFA02710440000B16E', N'303443DFA027104000006BEE', N'30344381E0493E40400001D5', N'30344381E0493E4040000274', N'303443E36027104400003D2E', N'303443E36027294400000720', N'303443E36027104400001023', N'303443ED10271040400026A7', N'303443DFA0271044000060FC', N'303443E360271044000025D4', N'303443ED1027104040002515', N'303443E3602729440000070F', N'303443E3602710440000263E', N'303443E3602710404000427C', N'303443ED1027104040002A06', N'303443E36027104400002F49', N'303443DFA027104040006290', N'303443E3602710404000383C', N'303443E360271040400039AC', N'303443DFA02710440001FFC6', N'303443E360271044000030B2', N'303443DFA0271040400065BE', N'30344381E0493E44000002F5', N'303443DFA027104040005E6C', N'303443DFA027104400002261', N'303443E360271044000011FA', N'303443ED1027104040002997', N'303443DFA027104040006849', N'303443828049894400000FF2', N'303443846433774040000246', N'303443846433774040000125', N'3034438464337740400008CF', N'3034438464337740400009F7', N'303443846433774040000BA8', N'30344381E0493E4040000032', N'3034438464337740400009F0', N'303443828049894400001CC4', N'303443828049894400000D50', N'303443DFA02710440000CFC9', N'303443828049894400000CE5', N'303443828049894400000D4B', N'303443828049894400000E67', N'30344381E0493E4040000049', N'303443846433774040000CA6', N'303443828049894400000FF3', N'303443828049894400001CED', N'303443846433774040000C1E', N'303443828049894400001B61', N'303443828049894400001CF7', N'303443ED1027104400000B0E', N'303443828049894400001B04', N'303443828049894400000D78', N'303443846433774040000D65', N'30344381E0493E4040000041', N'303443828049894400000EE8', N'303443828049894400000C41', N'303443828049894400001048', N'303443828049894400001AA4', N'30344382804989440000102D', N'303443828049894400000D48', N'303443828049894400000AEC', N'303443828049894400001364', N'303443828049894400000EDF', N'303443828049894400001144', N'303443828049894400000BFF', N'303443846433774040000674', N'303443DFA027104040006BA1', N'3034438280498944000009F7')
  AND OPTeile.Status BETWEEN 'A' AND 'W'
  AND OPTeile.LastScanTime < N'2017-05-22 00:00:00';

GO